<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,源码分析," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="首先事件最先传递给当前的Activity，由Activity的dispatchTouchEvent来进行事件分发。
Activity的dispatchTouchEvent代码如下
1234567891011121314151617181920212223/**  * Called to process touch screen events.  You can override this to">
<meta property="og:type" content="article">
<meta property="og:title" content="事件分发源码分析">
<meta property="og:url" content="http://yoursite.com/2021/01/19/事件分发源码分析/index.html">
<meta property="og:site_name" content="XuLiang's home">
<meta property="og:description" content="首先事件最先传递给当前的Activity，由Activity的dispatchTouchEvent来进行事件分发。
Activity的dispatchTouchEvent代码如下
1234567891011121314151617181920212223/**  * Called to process touch screen events.  You can override this to">
<meta property="og:image" content="https://bright-blog-1301150773.cos.ap-guangzhou.myqcloud.com/Window%E3%80%81DecorView%E3%80%81ContentView%E5%B1%82%E7%BA%A7%E5%85%B3%E7%B3%BB.png">
<meta property="og:image" content="https://bright-blog-1301150773.cos.ap-guangzhou.myqcloud.com/Touch%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%B5%81%E7%A8%8B.png">
<meta property="og:updated_time" content="2021-01-20T12:48:18.722Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="事件分发源码分析">
<meta name="twitter:description" content="首先事件最先传递给当前的Activity，由Activity的dispatchTouchEvent来进行事件分发。
Activity的dispatchTouchEvent代码如下
1234567891011121314151617181920212223/**  * Called to process touch screen events.  You can override this to">
<meta name="twitter:image" content="https://bright-blog-1301150773.cos.ap-guangzhou.myqcloud.com/Window%E3%80%81DecorView%E3%80%81ContentView%E5%B1%82%E7%BA%A7%E5%85%B3%E7%B3%BB.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/01/19/事件分发源码分析/"/>





  <title> 事件分发源码分析 | XuLiang's home </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">XuLiang's home</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/19/事件分发源码分析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="XuLiang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="XuLiang's home">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="XuLiang's home" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                事件分发源码分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-19T20:22:01+08:00">
                2021-01-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>首先事件最先传递给当前的Activity，由Activity的<code>dispatchTouchEvent</code>来进行事件分发。</p>
<p>Activity的<code>dispatchTouchEvent</code>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Called to process touch screen events.  You can override this to</div><div class="line">  * intercept all touch screen events before they are dispatched to the</div><div class="line">  * window.  Be sure to call this implementation for touch screen events</div><div class="line">  * that should be handled normally.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> ev The touch screen event.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@return</span> boolean Return true if this event was consumed.</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">    <span class="comment">// 空方法 当键盘、触摸、trackball事件被分发到当前Activity时，这个方法被回调</span></div><div class="line">    <span class="comment">// 子类重写这个方法可以用于感知用户与设备的交互</span></div><div class="line">    onUserInteraction();</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 1-1 这里把MotionEvent交由Window去处理，如果结果是true，代表事件被消费了，直接返回true就行</span></div><div class="line">  <span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 1-2 如果MotionEvent没有被处理，交回来给Activity的onTouchEvent来处理</span></div><div class="line">  <span class="keyword">return</span> onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在1-1这里，Activity就把MotionEvent交给Window去处理了，我们知道，Window的唯一子类就是<code>PhoneWindow</code>，所以接下来的流程我们就跳转到<code>PhoneWindow</code>里去看。</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is the top-level view of the window, containing the window decor.</span></div><div class="line"><span class="keyword">private</span> DecorView mDecor;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">  <span class="comment">// 2-1 PhoneWindow将MotionEvent移交给DecorView去处理</span></div><div class="line">  <span class="keyword">return</span> mDecor.superDispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2-1: PhoneWindow又将MotionEvent交由<code>DecorView</code>去处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">  <span class="comment">// 3-1 DecorView其实是一个FrameLayout super.dispatchTouchEvent调用的是ViewGroup的方法</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们知道<code>Window</code>、<code>DecorView</code>、<code>contentView</code>的层级如下图所示</p>
<p><img src="https://bright-blog-1301150773.cos.ap-guangzhou.myqcloud.com/Window%E3%80%81DecorView%E3%80%81ContentView%E5%B1%82%E7%BA%A7%E5%85%B3%E7%B3%BB.png" alt="Window、DecorView、ContentView层级关系"></p>
<p>DecorView的子控件<code>R.layout.screen_simple</code>、<code>R.id.content</code>这些都是ViewGroup。自己编写的<code>R.layout.main_activity</code>可以是View，也可以是ViewGroup。所以DecorView内部的控件就是ViewGroup一层一层嵌套，直到最后的View。所以我们继续从ViewGroup的<code>dispatchTouchEvent</code>往下看，这里也是ViewGroup分发事件的主要过程。</p>
<p><code>dispatchTouchEvent</code>方法有点长，我们拆解一下来看看，首先，我们手机在屏幕上点击或滑动，都是一系列的事件，每一次事件都是从<code>MotionEvent.ACTION_DOWN</code>开始的</p>
<ul>
<li><p>第一部分，就是对事件系列中的最开始<code>MotionEvent.ACTION_DOWN</code>的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">  </div><div class="line">    <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</div><div class="line">        <span class="comment">// ------------ 第一部分 针对事件初始进行前置准备处理 ------------</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</div><div class="line">        <span class="comment">// 最初的DOWN事件处理</span></div><div class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">            <span class="comment">// Throw away all previous state when starting a new touch gesture.</span></div><div class="line">            <span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></div><div class="line">            <span class="comment">// due to an app switch, ANR, or some other state change.</span></div><div class="line">          	<span class="comment">// 4-1 向mFirstTouchTarget指向的子元素分发cancel事件，然后将mFirstTouchTarget清除置为null</span></div><div class="line">            cancelAndClearTouchTargets(ev);</div><div class="line">          	<span class="comment">// 4-2 重置所有触摸状态，为下一个事件周期做准备</span></div><div class="line">            resetTouchState();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ------------ 第一部分 结束 ------------</span></div><div class="line">      </div><div class="line">				<span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4-1中<code>cancelAndClearTouchTargets</code>，作用就是清除之前的事件，为新一轮的事件分发做准备</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAndClearTouchTargets</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">boolean</span> syntheticEvent = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">          	<span class="comment">// 构建一个ACTION_CANCEL的事件</span></div><div class="line">            event = MotionEvent.obtain(now, now,</div><div class="line">                    MotionEvent.ACTION_CANCEL, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0</span>);</div><div class="line">            event.setSource(InputDevice.SOURCE_TOUCHSCREEN);</div><div class="line">            syntheticEvent = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (TouchTarget target = mFirstTouchTarget; target != <span class="keyword">null</span>; target = target.next) &#123;</div><div class="line">            resetCancelNextUpFlag(target.child);</div><div class="line">          	<span class="comment">// 向mFirstTouchTarget指向的子元素分发cancel事件</span></div><div class="line">            dispatchTransformedTouchEvent(event, <span class="keyword">true</span>, target.child, target.pointerIdBits);</div><div class="line">        &#125;</div><div class="line">      	<span class="comment">// 清除mFirstTouchTarget中的节点，置为null</span></div><div class="line">        clearTouchTargets();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (syntheticEvent) &#123;</div><div class="line">            event.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4-2中的<code>resetTouchState</code>就是 重置所有触摸状态，为下一个事件周期做准备</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetTouchState</span><span class="params">()</span> </span>&#123;</div><div class="line">    clearTouchTargets();</div><div class="line">    resetCancelNextUpFlag(<span class="keyword">this</span>);</div><div class="line">    mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;</div><div class="line">    mNestedScrollAxes = SCROLL_AXIS_NONE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>第二部分 处理当前ViewGroup是否要拦截事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ------------ 第二部分 判断当前ViewGroup是否需要拦截事件 ------------      </span></div><div class="line">    <span class="comment">// Check for interception.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</div><div class="line">    <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (!disallowIntercept) &#123;</div><div class="line">            intercepted = onInterceptTouchEvent(ev);</div><div class="line">            ev.setAction(action); <span class="comment">// restore action in case it was changed</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            intercepted = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// There are no touch targets and this action is not an initial down</span></div><div class="line">        <span class="comment">// so this view group continues to intercept touches.</span></div><div class="line">        intercepted = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"><span class="comment">// ------------ 第二部分 结束 ------------</span></div></pre></td></tr></table></figure>
<p>定义一个<code>boolean</code>类型的标志量<code>intercepted</code>，这个是用于记录该ViewGroup是否要拦截事件，可以看到 ViewGroup会在<code>actionMasked == MotionEvent.ACTION_DOWN</code>和<code>mFirstTouchTarget != null</code>这个条件下来进行是否需要拦截事件的判断，<code>mFirstTouchTarget</code>指向的是该ViewGroup的能处理事件成功的子View。那么如果ViewGroup拦截了事件，<code>mFirstTouchTarget</code>就是为null的，那么接下来的MOVE和UP事件则继续保持拦截状态，不会进入判断条件。</p>
</li>
</ul>
<p>  然后在具体是否拦截的判断条件是是否设置了<code>FLAG_DISALLOW_INTERCEPT</code>标记位，如果设置了，该ViewGroup是不会拦截事件的，这个标志位一般是子View通过<code>getParent().requestDisallowInterceptTouchEvent(true)</code>来设置，子View请求父控件不要拦截事件。如果没有设置，再通过该ViewGroup自身的<code>onInterceptTouchEvent(ev)</code>方法返回值来判断是否需要拦截，这个方法通常就是继承类来覆写该方法来控制是否拦截事件。</p>
<ul>
<li><p>第三部分 遍历子View，判断子View是否需要拦截或处理事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ------------ 第三部分 遍历子View，判断子View是否需要拦截或处理事件 ------------      </span></div><div class="line"><span class="comment">// Check for cancelation.</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</div><div class="line">        || actionMasked == MotionEvent.ACTION_CANCEL;</div><div class="line"></div><div class="line"><span class="comment">// Update list of touch targets for pointer down, if needed.</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</div><div class="line">TouchTarget newTouchTarget = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</div><div class="line"><span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</div><div class="line">    <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">            || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</div><div class="line">            || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex(); <span class="comment">// always 0 for down</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> idBitsToAssign = split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</div><div class="line">                : TouchTarget.ALL_POINTER_IDS;</div><div class="line"></div><div class="line">        <span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></div><div class="line">        <span class="comment">// have become out of sync.</span></div><div class="line">        removePointersFromTouchTargets(idBitsToAssign);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">        <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line">            <span class="comment">// Find a child that can receive the event.</span></div><div class="line">            <span class="comment">// Scan children from front to back.</span></div><div class="line">            <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">                    &amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">            <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">          	<span class="comment">// 5-1 从最前面往里面遍历子View</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childIndex = getAndVerifyPreorderedIndex(</div><div class="line">                        childrenCount, i, customOrder);</div><div class="line">                <span class="keyword">final</span> View child = getAndVerifyPreorderedView(</div><div class="line">                        preorderedList, children, childIndex);</div><div class="line">								<span class="comment">// 5-2 判断子View是否能够接受到事件</span></div><div class="line">                <span class="keyword">if</span> (!canViewReceivePointerEvents(child)</div><div class="line">                        || !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</div><div class="line">                    ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                newTouchTarget = getTouchTarget(child);</div><div class="line">                <span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Child is already receiving touch within its bounds.</span></div><div class="line">                    <span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></div><div class="line">                    newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                resetCancelNextUpFlag(child);</div><div class="line">              	<span class="comment">// 5-3 将事件交由子View去dispatchTouchEvent，看子View是否处理事件</span></div><div class="line">                <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line">                    <span class="comment">// Child wants to receive touch within its bounds.</span></div><div class="line">                    mLastTouchDownTime = ev.getDownTime();</div><div class="line">                    <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// childIndex points into presorted list, find original index</span></div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</div><div class="line">                            <span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</div><div class="line">                                mLastTouchDownIndex = j;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        mLastTouchDownIndex = childIndex;</div><div class="line">                    &#125;</div><div class="line">                    mLastTouchDownX = ev.getX();</div><div class="line">                    mLastTouchDownY = ev.getY();</div><div class="line">                  	<span class="comment">// 5-4 将处理事件的View添加到mFirstTouchTarget(链表)最前端</span></div><div class="line">                    newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">                    alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Did not find a child to receive the event.</span></div><div class="line">            <span class="comment">// Assign the pointer to the least recently added target.</span></div><div class="line">            newTouchTarget = mFirstTouchTarget;</div><div class="line">            <span class="keyword">while</span> (newTouchTarget.next != <span class="keyword">null</span>) &#123;</div><div class="line">                newTouchTarget = newTouchTarget.next;</div><div class="line">            &#125;</div><div class="line">            newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ------------ 第三部分 结束 ------------</span></div></pre></td></tr></table></figure>
<p>在5-1处，从外层往里层依次遍历子View，然后在5-2处判断子View是否能够接受处理事件，判断条件是<code>canViewReceivePointerEvents(child)</code>和<code>isTransformedTouchPointInView(x, y, child, null)</code>，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">canViewReceivePointerEvents</span><span class="params">(@NonNull View child)</span> </span>&#123;</div><div class="line">  	<span class="comment">// 是否可见，是否在播放动画</span></div><div class="line">    <span class="keyword">return</span> (child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isTransformedTouchPointInView</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y, View child,</span></span></div><div class="line">        PointF outLocalPoint) &#123;</div><div class="line">  	<span class="comment">// 判断点击事件是否在子View的区域内</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span>[] point = getTempPoint();</div><div class="line">    point[<span class="number">0</span>] = x;</div><div class="line">    point[<span class="number">1</span>] = y;</div><div class="line">    transformPointToViewLocal(point, child);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isInView = child.pointInView(point[<span class="number">0</span>], point[<span class="number">1</span>]);</div><div class="line">    <span class="keyword">if</span> (isInView &amp;&amp; outLocalPoint != <span class="keyword">null</span>) &#123;</div><div class="line">        outLocalPoint.set(point[<span class="number">0</span>], point[<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> isInView;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是说子View不能接收点击事件或者点击事件不在该子View的区域内，那么事件也就不会分发到这个子View去，跳过这个子View继续遍历。</p>
<p>如果子View满足这两个条件，那么事件就会传递给它来处理，进入5-3处的 <code>dispatchTransformedTouchEvent</code>来看，撇开那些判断条件，最终的处理结果都依赖下面的代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">    handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    handled = child.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里child传入的不为null，所以这里会执行子View的<code>dispatchTouchEvent</code>，如果<code>dispatchTouchEvent</code>返回的是true，那就暂时不考虑子View内部的分发逻辑，这里会走进if判断条件，执行到5-4处。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> TouchTarget <span class="title">addTouchTarget</span><span class="params">(@NonNull View child, <span class="keyword">int</span> pointerIdBits)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> TouchTarget target = TouchTarget.obtain(child, pointerIdBits);</div><div class="line">    target.next = mFirstTouchTarget;</div><div class="line">    mFirstTouchTarget = target;</div><div class="line">    <span class="keyword">return</span> target;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里是对<code>mFirstTouchTarget</code>进行赋值，然后将<code>mFirstTouchTarget</code>当成一个子View是否处理事件的标志。如果是有子View处理事件，将<code>mFirstTouchTarget</code>赋值后，然后就跳出遍历子View的循环，如果当前子View的<code>dispatchTransformedTouchEvent</code>返回的是false，则继续往下遍历子View。</p>
</li>
<li><p>第四部分 根据<code>mFirstTouchTarget</code>来分发事件，为null则是将事件交由ViewGroup的onTouchEvent处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ------------ 第四部分 根据mFirstTouchTarget来分发事件，为null则是ViewGroup的onTouchEvent处理 ------------ </span></div><div class="line"><span class="comment">// Dispatch to touch targets.</span></div><div class="line"><span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">// No touch targets so treat this as an ordinary view.</span></div><div class="line">  	<span class="comment">// 6-1 如果事件被该ViewGroup拦截了，或者没有子view处理事件</span></div><div class="line">    handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</div><div class="line">            TouchTarget.ALL_POINTER_IDS);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></div><div class="line">    <span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></div><div class="line">  	<span class="comment">// 6-1 遍历mFirstTouchTarget，分发事件</span></div><div class="line">    TouchTarget predecessor = <span class="keyword">null</span>;</div><div class="line">    TouchTarget target = mFirstTouchTarget;</div><div class="line">    <span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> TouchTarget next = target.next;</div><div class="line">        <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</div><div class="line">            handled = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</div><div class="line">                    || intercepted;</div><div class="line">            <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</div><div class="line">                    target.child, target.pointerIdBits)) &#123;</div><div class="line">                handled = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (cancelChild) &#123;</div><div class="line">                <span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</div><div class="line">                    mFirstTouchTarget = next;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    predecessor.next = next;</div><div class="line">                &#125;</div><div class="line">                target.recycle();</div><div class="line">                target = next;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        predecessor = target;</div><div class="line">        target = next;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ------------ 第四部分 结束 ------------</span></div></pre></td></tr></table></figure>
<p>接着第三部分，如果没有子View没有处理事件(1. 有可能没有子View 2. 子View处理了事件，dispatchTouchEvent返回false)，这个时候<code>mFirstTouchTarget</code>是没有赋值的，为null，那么会走到代码6-1处。</p>
<p>这里跟5-3处调用的是一个方法，但是child参数传递的是null，那么就会执行<code>super.dispatchTouchEvent(event)</code>这行代码，会跳转到ViewGroup的父类View的<code>dispatchTouchEvent</code>，而View的<code>dispatchTouchEvent</code>就会调用<code>onTouchEvent</code>，也就是该ViewGroup自己通过<code>onTouchEvent</code>方法来处理事件。</p>
</li>
</ul>
<p>到这里，ViewGroup里的事件分发与拦截就分析完毕了，事件要么就交由下层View继续处理，要么就走到自己的<code>onTouchEvent</code>方法里处理。如果下层View还是ViewGroup，则逻辑还是跟上面分析的一样，如果是View，那么流程就有点不同了。</p>
<ul>
<li><p>View的dispatchTouchEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">        <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</div><div class="line">            result = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">        ListenerInfo li = mListenerInfo;</div><div class="line">        <span class="comment">// 7-1 判断是否设置了OnTouchListener，设置了就交由listener处理</span></div><div class="line">        <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line">                &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">                &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line">            result = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 7-2 没设置OnTouchListener，交由View的onTouchEvent方法来处理事件</span></div><div class="line">        <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">            result = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>View因为没有下层的子View了，所以dispatchTouchEvent也比较简单，从代码7-1和7-2可以很清晰看到View分发事件的逻辑，首先看是否设置了OnTouchEventListener，如果没有设置listener，再去看该View的onTouchEvent方法。OnTouchEventListener的优先级是高于onTouchEvent方法的，这样就可以暴露OnTouchEventListener，方便于View在外面处理点击事件了。</p>
</li>
</ul>
<ul>
<li><p>View的onTouchEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> x = event.getX();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> y = event.getY();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction();</div><div class="line"></div><div class="line">    <span class="comment">// ------------ 第一部分 View处于不可用状态下点击事件的处理  ------------</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> clickable = ((viewFlags &amp; CLICKABLE) == CLICKABLE</div><div class="line">            || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</div><div class="line">            || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</div><div class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">            setPressed(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</div><div class="line">        <span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">        <span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">      	<span class="comment">// 不可用状态下，view也会消耗事件，只是不响应它们</span></div><div class="line">        <span class="keyword">return</span> clickable;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ------------ 第一部分 结束  ------------</span></div><div class="line">    </div><div class="line">    <span class="comment">// ------------ 第二部分 有TouchDelegate则交由TouchDelegate处理事件  ------------</span></div><div class="line">    <span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ------------ 第二部分 结束  ------------</span></div><div class="line">  </div><div class="line">    <span class="comment">// ------------ 第三部分 点击事件的具体处理  ------------</span></div><div class="line">    <span class="keyword">if</span> (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</div><div class="line">        <span class="keyword">switch</span> (action) &#123;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">                mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</div><div class="line">                <span class="keyword">if</span> ((viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</div><div class="line">                    handleTooltipUp();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!clickable) &#123;</div><div class="line">                    removeTapCallback();</div><div class="line">                    removeLongPressCallback();</div><div class="line">                    mInContextButtonPress = <span class="keyword">false</span>;</div><div class="line">                    mHasPerformedLongPress = <span class="keyword">false</span>;</div><div class="line">                    mIgnoreNextUpEvent = <span class="keyword">false</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</div><div class="line">                    <span class="comment">// take focus if we don't have it already and we should in</span></div><div class="line">                    <span class="comment">// touch mode.</span></div><div class="line">                    <span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</div><div class="line">                    <span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</div><div class="line">                        focusTaken = requestFocus();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (prepressed) &#123;</div><div class="line">                        <span class="comment">// The button is being released before we actually</span></div><div class="line">                        <span class="comment">// showed it as pressed.  Make it show the pressed</span></div><div class="line">                        <span class="comment">// state now (before scheduling the click) to ensure</span></div><div class="line">                        <span class="comment">// the user sees it.</span></div><div class="line">                        setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</div><div class="line">                        <span class="comment">// This is a tap, so remove the longpress check</span></div><div class="line">                        removeLongPressCallback();</div><div class="line"></div><div class="line">                        <span class="comment">// Only perform take click actions if we were in the pressed state</span></div><div class="line">                        <span class="keyword">if</span> (!focusTaken) &#123;</div><div class="line">                            <span class="comment">// Use a Runnable and post this rather than calling</span></div><div class="line">                            <span class="comment">// performClick directly. This lets other visual state</span></div><div class="line">                            <span class="comment">// of the view update before click actions start.</span></div><div class="line">                          	<span class="comment">// 8-1 针对点击事件处理 通过Runnable调用performClickInternal() ，最终调用performClick()方法</span></div><div class="line">                            <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</div><div class="line">                                mPerformClick = <span class="keyword">new</span> PerformClick();</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">if</span> (!post(mPerformClick)) &#123;</div><div class="line">                                performClickInternal();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) &#123;</div><div class="line">                        mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (prepressed) &#123;</div><div class="line">                        postDelayed(mUnsetPressedState,</div><div class="line">                                ViewConfiguration.getPressedStateDuration());</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) &#123;</div><div class="line">                        <span class="comment">// If the post failed, unpress right now</span></div><div class="line">                        mUnsetPressedState.run();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    removeTapCallback();</div><div class="line">                &#125;</div><div class="line">                mIgnoreNextUpEvent = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">                <span class="keyword">if</span> (event.getSource() == InputDevice.SOURCE_TOUCHSCREEN) &#123;</div><div class="line">                    mPrivateFlags3 |= PFLAG3_FINGER_DOWN;</div><div class="line">                &#125;</div><div class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!clickable) &#123;</div><div class="line">                  	<span class="comment">// 8-2 针对长按事件处理 </span></div><div class="line">                    checkForLongClick(<span class="number">0</span>, x, y);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Walk up the hierarchy to determine if we're inside a scrolling container.</span></div><div class="line">                <span class="keyword">boolean</span> isInScrollingContainer = isInScrollingContainer();</div><div class="line"></div><div class="line">                <span class="comment">// For views inside a scrolling container, delay the pressed feedback for</span></div><div class="line">                <span class="comment">// a short period in case this is a scroll.</span></div><div class="line">                <span class="keyword">if</span> (isInScrollingContainer) &#123;</div><div class="line">                    mPrivateFlags |= PFLAG_PREPRESSED;</div><div class="line">                    <span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) &#123;</div><div class="line">                        mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</div><div class="line">                    &#125;</div><div class="line">                    mPendingCheckForTap.x = event.getX();</div><div class="line">                    mPendingCheckForTap.y = event.getY();</div><div class="line">                    postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Not inside a scrolling container, so show the feedback right away</span></div><div class="line">                    setPressed(<span class="keyword">true</span>, x, y);</div><div class="line">                    checkForLongClick(<span class="number">0</span>, x, y);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">                <span class="keyword">if</span> (clickable) &#123;</div><div class="line">                    setPressed(<span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">                removeTapCallback();</div><div class="line">                removeLongPressCallback();</div><div class="line">                mInContextButtonPress = <span class="keyword">false</span>;</div><div class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</div><div class="line">                mIgnoreNextUpEvent = <span class="keyword">false</span>;</div><div class="line">                mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">                <span class="keyword">if</span> (clickable) &#123;</div><div class="line">                    drawableHotspotChanged(x, y);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Be lenient about moving outside of buttons</span></div><div class="line">                <span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">                    <span class="comment">// Outside button</span></div><div class="line">                    <span class="comment">// Remove any future long press/tap checks</span></div><div class="line">                    removeTapCallback();</div><div class="line">                    removeLongPressCallback();</div><div class="line">                    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">                        setPressed(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ------------ 第三部分 结束  ------------</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上代码我们可以看到，View的OnTouchEvent方法主要分为三个部分，首先对不可用的状态进行处理，虽然处于不可用状态，但是还是会消费点击事件，只是没什么响应而已。第二部分则是对设置了<code>TouchDelegate</code>的处理。重点在第三部分，这里就是我们非常熟悉的针对MotionEvent不同action类型(DOWN、MOVE、CANCEL、UP)的处理。</p>
<p>其中8-1代码处就是针对点击事件处理，通过post Runnable调用<code>performClickInternal()</code>，确保view的状态在点击前进行一遍更新。最终调用<code>performClick()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// We still need to call this method to handle the cases where performClick() was called</span></div><div class="line">    <span class="comment">// externally, instead of through performClickInternal()</span></div><div class="line">    notifyAutofillManagerOnClick();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> result;</div><div class="line">    <span class="keyword">final</span> ListenerInfo li = mListenerInfo;</div><div class="line">  	<span class="comment">// 在这里回调出去，具体处理View的onClick事件</span></div><div class="line">    <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">        playSoundEffect(SoundEffectConstants.CLICK);</div><div class="line">        li.mOnClickListener.onClick(<span class="keyword">this</span>);</div><div class="line">        result = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        result = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</div><div class="line"></div><div class="line">    notifyEnterOrExitForAutoFillIfNeeded(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>8-2处代码是在MotionEvent.ACTION_DOWN里去判断view要不要响应长按事件，具体实现跟点击事件类似，最终响应到View的<code>OnLongClickListener</code>去处理长按事件，这里具体就不再展开了。</p>
</li>
</ul>
<p>总结</p>
<ol>
<li><code>onInterceptTouchEvent</code>方法代表是否需要拦截事件，<code>onTouch</code>和<code>onTouchEvent</code>方法的返回值代表是否消费事件</li>
<li>事件从Activity一层一层往底部View进行分发，过程中，各个ViewGroup都可以选择拦截事件，拦截后则交由该ViewGroup的<code>onTouchEvent</code>处理，不再继续分发</li>
<li>都不拦截的情况下，会分发到子View，如果view都不选择消费事件，事件会通过<code>onTouchEvent</code>一层一层往上冒泡，直到回到Activity的<code>onTouchEvent</code>，有一层选择消费事件，则不再往上传递</li>
<li>子View可以通过<code>getParent().requestDisallowInterceptTouchEvent</code>来申请父控件不要拦截事件</li>
<li>如果View没有消费<code>ACTION_DOWN</code>事件，之后的<code>ACTION_MOVE\ACTION_UP</code>事件不会再接收</li>
<li>当View设置了可点击、可常按，那么就算该View不可用，也会消费事件</li>
<li><code>onTouch</code>优先级比<code>onTouchEvent</code>高，只有<code>onTouch</code>不执行的情况下，才会执行<code>onTouchEvent</code></li>
</ol>
<p>事件分发流程图如下：</p>
<p><img src="https://bright-blog-1301150773.cos.ap-guangzhou.myqcloud.com/Touch%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%B5%81%E7%A8%8B.png" alt="Touch事件分发流程"></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/源码分析/" rel="tag"># 源码分析</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/10/LayoutInflater源码分析/" rel="next" title="LayoutInflater源码分析">
                <i class="fa fa-chevron-left"></i> LayoutInflater源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="XuLiang" />
          <p class="site-author-name" itemprop="name">XuLiang</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XuLiang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  

  


</body>
</html>
